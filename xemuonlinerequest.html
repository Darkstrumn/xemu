<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <!-- <base href="http://github.lgb.hu/xemu/" target="_blank"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Xemu Download Page</title>
    <link rel="shortcut icon" type="image/png" href="favico.png">
  </head>

  <body onLoad="main()">

	<span id="JSwarningContainer" style="display: block;">
		<p align="center"><b>You must enable JavaScript to be able to use this page. Or your browser is too ancient to understand modern (ES6 or greater) JavaScript code ...
		<br><br>
		You'll also get this message if you try to visit the page at your own, without using Xemu's context menu to visit.
		<br><br>
		Finally, it's also possible that you only need to wait a bit at this point :)</b></p>
	</span>

	<!-- <span id="jsErrorContainer" style="display: none; font-weight: bold; text-color: red;">
		<p align="center">JS ERROR!</p>
	</span> -->

	<span id="mainContainer" style="display: none;">


    <header>
      <div class="inner">
        <h1>Xemu</h1>
	<h2>Collection of emulators, written by me<sup>*</sup>.</h2>
        <a href="https://github.com/lgblgblgb/xemu" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">

<h1>
	<a id="x-emulators" class="anchor" href="#x-emulators" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>
	Xemu on-line
</h1>

<h2>Version information</h2>

<p>This page was requested by <span id="myOfficialContainer">???</span> Xemu build target <span id="myTargetContainer">???</span> version <span id="myVersionContainer">???</span> on platform <span id="myPlatformContainer">???</span> from branch <span id="myBranchContainer">???</span> commit <span id="myCommitIdContainer">???</span> in repository <span id="myRepoURLContainer">???</span>
(<a href="#" target="_new" id="commit-link">LINK</a>).
</p>

<p>Xemu update checker status: <span id="versionCheckContainer"></span></p>

<span id="pageAgeWarningContainer" style="display: none"><p style="font-weight: bold; color: red; text-align: center;">
This page was requested at least several hours ago. Version/token information may has changed since then.
Please use Xemu's UI context menu to re-request this page!
</p></span>

<h2>Help resources</h2>

<span id="helpContainer"></span>


<!-- end of custom stuff -->

        </section>

        <aside id="sidebar">

	  <a href="https://lgblgblgb.github.io/xemu/" class="button">
            <small>Download</small>
            builds
	  </a>
          <a href="https://github.com/lgblgblgb/xemu" class="button">
            <small>Visit</small>
            Project
          </a>
          <a href="https://github.com/lgblgblgb/xemu/wiki" class="button">
            <small>Visit</small>
            Wiki
          </a>

	  <p class="repo-owner"><sup><b>*</b></sup> author of <a href="https://github.com/lgblgblgb/xemu">Xemu</a> &amp; maintainer of this page: <a href="https://github.com/lgblgblgb">Gábor Lénárt (LGB)</a>.</p>
	  <p><i>theme: "Architect" by <a href="https://twitter.com/jasonlong">Jason Long</a></i></p>
        </aside>
      </div>
    </div>


</span><!-- mainContainer -->
</body>


<script>

"use strict";

// (C)2020 Gabor Lenart LGB
// Part of the Xemu project.

function setSpan ( name, value )
{
	if (typeof(value) !== "string") {
		//document.getElementById("jsErrorContainer").style.display = "block";
		throw("Undefined value given for updating span " + name);
	}
	let e = document.getElementById(name);
	e.innerHTML = value;
	e.style = "color: blue; font-weight: bold; border-bottom: dashed black 1px;";
}

function showPage ( custom_content )
{
	document.getElementById("JSwarningContainer").style.display = "none";
	let e = document.getElementById("mainContainer");
	e.style.display = "block";
	if (custom_content)
		e.innerHTML = custom_content;
	console.log("Page visibility is turned ON" + (custom_content ? ": " + custom_content : ""));
}

function redirect ( url, alert_msg )
{
	showPage("About redirecting (please wait!) to: " + url);
	if (alert_msg)
		window.alert(alert_msg);
	self.location = url;

}

function main ()
{
	const unofficial_build_version_check = true;
	const mega65_help_url = "https://github.com/lgblgblgb/xemu/wiki/MEGA65-help";
	const c65_help_url = "https://github.com/lgblgblgb/xemu/wiki/C65-help";
	const mega65_book_pdf_url = "https://mega.scryptos.com/sharefolder-link/MEGA/MEGA65+filehost/Docs/MEGA65-Book_draft.pdf";

	const request_token = (new URLSearchParams(window.location.search)).get("xemuonlinehelprequesttoken");
	if (typeof(request_token) != "string") {
		console.log("No Xemu request GET parameter found ...");
		return redirect("index.html", "This page should not be visited by your browser\nbut using Xemu's help menu.");
	}
	if (self != top) {
		console.log("Frame protection activated ...");
		top.location = self.location;
		return;
	}
	let vars = {};
	const request = request_token.split("\u0002");
	/*let need_digest = await sha1(request[0]);
	if (need_digest == request[1]) {
		console.log("Good, checksum is OK!");
	} else {
		console.log("Bad, checksum is NOT OK!! expected='" + need_digest + "', got='" + request[1] + "'");
	}*/
	for (const p of request[0].split("\u0001")) {
		if (p[0] !== '=' && p[1] === '=') {
			vars[p[0]] = (p[0] === "b" ? p.substring(2).split(" ") : p.substring(2));
		}
	}
	console.log(vars);

	setSpan("myBranchContainer",	vars["b"][1]);
	setSpan("myVersionContainer",	vars["v"]);
	setSpan("myPlatformContainer",	vars["p"]);
	setSpan("myTargetContainer",	vars["t"]);
	setSpan("myOfficialContainer",	(vars["o"] === "1" ? "official" : "custom"));
	setSpan("myCommitIdContainer",	vars["b"][2]);
	setSpan("myRepoURLContainer",	vars["b"][0]);

	document.getElementById("commit-link").href = vars["b"][0].replace(/\.git$/, "") + "/commit/" + vars["b"][2];

	const command = vars["x"];
	if (command === "downloadmega65book")
		return redirect(
			mega65_book_pdf_url,
			"Redirecting for downloading MEGA65-book.\nYou may need to accept terms and conditions though,\nat the download site."
		);
	if (command.includes("://"))
		return redirect(vars["x"], "");
	if (command == "downloadpage")
		return redirect("index.html", "");

	let version = parseInt(vars["v"]);
	if (("" + version) !== vars["v"] || version < 20000000000000 || version > 29990000000000 ) {
		console.log("Bad version number!");
		window.alert("Invalid version number got! Result is non-sense.");
		version = 0;
	}

	const now = Date.now() / 1000;
	const reqTime = parseInt(vars["u"]);
	const hoursSince = (now - reqTime) / 3600;
	console.log("Page request age: " + hoursSince);

	if (Math.abs(hoursSince) >= 24.0) {
		console.log("Too old (based on age)!");
		document.getElementById("pageAgeWarningContainer").style.display = "block";
	}

	if (version && (vars["o"] === "1" || unofficial_build_version_check)) {
		let branch = vars["b"][1].toLowerCase();
		let platform = vars["p"].toLowerCase();
		if (platform === "win32" || platform === "win64" || platform == "win")
			platform = "windows";
		if (platform === "mac" || platform === "macos")
			platform = "osx";
		const VER_URL = "https://raw.githubusercontent.com/lgblgblgb/xemu-binaries/binary-" + platform + "-" + branch + "/versioninfo?timeid=" + now;
		console.log("Checking for new version by fetching " + VER_URL);
		let ajax = new XMLHttpRequest();
		ajax.updateElement = document.getElementById("versionCheckContainer");
		ajax.updateElement.innerHTML = "Check in progress ...";
		ajax.yourVersion = version;
		ajax.yourBranch = branch;
		ajax.onreadystatechange = function() {
			if (this.readyState == 4) {
				let style = this.updateElement.style;
				let result;
				if (this.status == 200) {
					console.log("Got result with 200 (OK) answer: " + this.responseText);
					let latest = parseInt(this.responseText);
					let length_ok = (("" + latest).length === ("" + ajax.yourVersion).length);
					console.log("Latest version is " + latest + " your version is " + ajax.yourVersion);
					if (length_ok) {
						if (latest == ajax.yourVersion) {
							result = "Great, you have the latest version in branch " + this.yourBranch;
							style.color = "green";
						} else if (latest > ajax.yourVersion) {
							result = "There is newer (" + latest + ") version available in branch " + this.yourBranch + "!";
							style.color = "red";
						} else {
							result = "Wow, you have newer version than the latest (" + latest + ")?! :-O";
							style.color = "red";
						}
					} else {
						console.log("Bad version length got!");
						result = "Invalid version response from the download site!";
						style.color = "red";
					}
				} else {
					console.log("Result problem, response is not 200 (OK) but: " + this.status);
					result = "Cannot get current version at the download-site (error " + this.status + ")";
					style.color = "red";
				}
				style.fontWeight = "bold";
				style.borderBottom = "1px black dashed";
				this.updateElement.innerHTML = result;
			}
		};
		ajax.open("GET", VER_URL, true);
		ajax.send();
	} else {
		let e = document.getElementById("versionCheckContainer");
		e.innerHTML = "Only for Xemu binary distributions downloaded from the official site can use the update checker!";
		e.style.color = "red";
		e.style.fontWeight = "bold";
		e.style.borderBottom = "1px black dashed";
	}

	let help = [];
	const target = vars["t"];
	help.push("<a href='index.html?showversions=" + version + "&amp;timeid=" + now + "'>Xemu builds download page</a>");
	if (target === "mega65") {
		if (command === "help")
			return redirect(mega65_help_url, "");
		help.push("<a target='_new' href='" + mega65_help_url + "'><b>Xemu MEGA65 help page</b></a>");
		help.push("<a target='_new' href='https://mega65.org'>The MEGA65 project</a>");
		help.push("<a target='_new' href='https://www.forum64.de/index.php?board/457-mega65/'>MEGA65 forum</a>");
		help.push("<a target='_new' href='https://github.com/MEGA65'>MEGA65 github repositories</a>");
	} else if (target === "c65") {
		if (command === "help")
			return redirect(c65_help_url, "");
		help.push("<a target='_new' href='" + c65_help_url + "'><b>Xemu C65 help page</b></a>");
	}
	document.getElementById("helpContainer").innerHTML = "<ul><li>" + help.join("</li><li>") + "</li></ul>";
	showPage();
}
</script>
</html>
